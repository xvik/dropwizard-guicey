
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Dropwizard guice integration">
      
      
        <link rel="canonical" href="https://xvik.github.io/dropwizard-guicey/4.0.1/examples/jdbi/">
      
      
        <meta name="author" content="Vyacheslav Rusakov">
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.ico">
      
      <meta name="generator" content="mkdocs+mkdocs-material#1.0.3">
    
    
      
        <title>JDBI - Dropwizard-guicey</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-facb31f4a3.js"></script>
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-f3ab63f78a.css">
      
      
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Dropwizard-guicey" class=" md-icon md-icon--home  md-header-nav__button">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Examples
                </span>
              
            
            JDBI
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            
              


  


  <a href="https://github.com/xvik/dropwizard-guicey" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      dropwizard-guicey
    </div>
  </a>

            
          </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <i class=" md-icon md-icon--home  md-nav__button">
      
    </i>
    Dropwizard-guicey
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/xvik/dropwizard-guicey" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      dropwizard-guicey
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  <li class="md-nav__item">
    
      <a href="../.." title="Home" class="md-nav__link">
        Home
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item">
    
      <a href="../../getting-started/" title="Getting started" class="md-nav__link">
        Getting started
      </a>
    
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      User guide
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-3">
        User guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/configuration/" title="Configuration" class="md-nav__link">
        Configuration
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/lifecycle/" title="Integration lifecycle" class="md-nav__link">
        Integration lifecycle
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/injector/" title="Injector" class="md-nav__link">
        Injector
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/module-autowiring/" title="Module autowiring" class="md-nav__link">
        Module autowiring
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/bindings/" title="Bindings" class="md-nav__link">
        Bindings
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/scan/" title="Classpath scan" class="md-nav__link">
        Classpath scan
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/installers/" title="Installers" class="md-nav__link">
        Installers
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/ordering/" title="Ordering" class="md-nav__link">
        Ordering
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/bundles/" title="Bundles (Guicey)" class="md-nav__link">
        Bundles (Guicey)
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/options/" title="Options" class="md-nav__link">
        Options
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/diagnostic/" title="Diagnostic" class="md-nav__link">
        Diagnostic
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/commands/" title="Commands" class="md-nav__link">
        Commands
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/web/" title="Web" class="md-nav__link">
        Web
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../guide/test/" title="Test" class="md-nav__link">
        Test
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Installers
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-4">
        Installers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/resource/" title="Resource" class="md-nav__link">
        Resource
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/task/" title="Task" class="md-nav__link">
        Task
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/managed/" title="Managed" class="md-nav__link">
        Managed
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/lifecycle/" title="Lifecycle" class="md-nav__link">
        Lifecycle
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/healthcheck/" title="Health check" class="md-nav__link">
        Health check
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/jersey-ext/" title="Jersey extension" class="md-nav__link">
        Jersey extension
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/jersey-feature/" title="Jersey feature" class="md-nav__link">
        Jersey feature
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/eager/" title="Eager singleton" class="md-nav__link">
        Eager singleton
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/plugin/" title="Plugin" class="md-nav__link">
        Plugin
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/servlet/" title="Web servlet" class="md-nav__link">
        Web servlet
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/filter/" title="Web filter" class="md-nav__link">
        Web filter
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../installers/listener/" title="Web listener" class="md-nav__link">
        Web listener
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-5">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../authentication/" title="Authentication" class="md-nav__link">
        Authentication
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../governator/" title="Governator" class="md-nav__link">
        Governator
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../hibernate/" title="Hibernate" class="md-nav__link">
        Hibernate
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../eventbus/" title="EventBus" class="md-nav__link">
        EventBus
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        JDBI
      </label>
    
    <a href="./" title="JDBI" class="md-nav__link md-nav__link--active">
      JDBI
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repository-definition" title="Repository definition" class="md-nav__link">
    Repository definition
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#result-set-mapper" title="Result set mapper" class="md-nav__link">
    Result set mapper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Extras
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-6">
        Extras
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../extras/admin-rest/" title="Admin REST" class="md-nav__link">
        Admin REST
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../extras/bom/" title="BOM" class="md-nav__link">
        BOM
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../extras/eventbus/" title="Guava EventBus" class="md-nav__link">
        Guava EventBus
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../extras/jdbi/" title="JDBI" class="md-nav__link">
        JDBI
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
  <li class="md-nav__item">
    
      <a href="../../about/compatibility/" title="Compatibility" class="md-nav__link">
        Compatibility
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../about/history/" title="Release notes" class="md-nav__link">
        Release notes
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../about/support/" title="Support" class="md-nav__link">
        Support
      </a>
    
  </li>

        
          
          
  <li class="md-nav__item">
    
      <a href="../../about/license/" title="License" class="md-nav__link">
        License
      </a>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configuration" title="Configuration" class="md-nav__link">
    Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repository-definition" title="Repository definition" class="md-nav__link">
    Repository definition
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#result-set-mapper" title="Result set mapper" class="md-nav__link">
    Result set mapper
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/xvik/dropwizard-guicey/edit/master/src/doc/docs/examples\jdbi.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="jdbi-integration">JDBI integration<a class="headerlink" href="#jdbi-integration" title="Permanent link">&para;</a></h1>
<p>Example of <a href="../../extras/jdbi/">guicey-jdbi</a> extension usage.</p>
<div class="admonition note">
<p>Example <a href="https://github.com/xvik/dropwizard-guicey-examples/tree/master/jdbi">source code</a></p>
</div>
<p><a href="../../extras/jdbi/">JDBI extension</a> used for:</p>
<ul>
<li>using jdbi proxies as guice beans</li>
<li>be able to use injection inside proxies</li>
<li>be able to use AOP on proxies</li>
<li>use annotations for transaction definition</li>
<li>automatic repositories and mapper installation</li>
</ul>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<p>Additional dependencies required:</p>
<div class="codehilite"><pre><span></span><span class="n">compile</span> <span class="s1">&#39;ru.vyarus.guicey:guicey-jdbi:0.2.1&#39;</span>
<span class="n">compile</span> <span class="s1">&#39;com.h2database:h2:1.4.193&#39;</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>guicey-jdbi version could be managed with <a href="../../extras/bom/">BOM</a></p>
</div>
<p><a href="http://www.dropwizard.io/1.0.6/docs/manual/jdbi.html">dropwizard-jdbi</a> is used to configure 
and create dbi instance:</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbiAppConfiguration</span> <span class="kd">extends</span> <span class="n">Configuration</span> <span class="o">{</span>

    <span class="nd">@Valid</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@JsonProperty</span>
    <span class="kd">private</span> <span class="n">DataSourceFactory</span> <span class="n">database</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataSourceFactory</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">DataSourceFactory</span> <span class="nf">getDatabase</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>For simplicity, embedded H2 database used:</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">database</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">driverClass</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">org.h2.Driver</span>
  <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sa</span>
  <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:h2:~/sample</span>
  <span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">charSet</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">UTF-8</span>
  <span class="l l-Scalar l-Scalar-Plain">maxWaitForConnection</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1s</span>
  <span class="l l-Scalar l-Scalar-Plain">validationQuery</span><span class="p p-Indicator">:</span> <span class="s">&quot;SELECT</span><span class="nv"> </span><span class="s">1&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">validationQueryTimeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3s</span>
  <span class="l l-Scalar l-Scalar-Plain">minSize</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
  <span class="l l-Scalar l-Scalar-Plain">maxSize</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">32</span>
  <span class="l l-Scalar l-Scalar-Plain">checkConnectionWhileIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">evictionInterval</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10s</span>
  <span class="l l-Scalar l-Scalar-Plain">minIdleTime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1 minute</span>
</pre></div>


<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Database scheme must be created manually. You can use 
<a href="https://github.com/dropwizard/dropwizard-flyway">dropwizard-flyway</a> module to prepare database. 
See <a href="https://github.com/xvik/dropwizard-guicey-examples/tree/master/jdbi">example app source</a> for details. </p>
</div>
<p>DBI instance created exactly as described in <a href="http://www.dropwizard.io/1.0.6/docs/manual/jdbi.html">dropwizard docs</a> 
using provided db configuration:</p>
<div class="codehilite"><pre><span></span><span class="n">GuiceBundle</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">bundles</span><span class="o">(</span><span class="n">JdbiBundle</span><span class="o">.&lt;</span><span class="n">JdbiAppConfiguration</span><span class="o">&gt;</span><span class="n">forDatabase</span><span class="o">((</span><span class="n">conf</span><span class="o">,</span> <span class="n">env</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">conf</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">()))</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can use <a href="../../extras/jdbi/#usage">pre-build dbi instance</a> instead.</p>
</div>
<h2 id="repository-definition">Repository definition<a class="headerlink" href="#repository-definition" title="Permanent link">&para;</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>All jdbi repositories must be annotated with <code>@JdbiRepository</code> to let <a href="../../extras/jdbi/#repository">repository installer</a>
recognize and properly install them.</p>
</div>
<div class="codehilite"><pre><span></span><span class="nd">@JdbiRepository</span>
<span class="nd">@InTransaction</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="n">Crud</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// have to use field injection because class is still used by dbi (which is no aware of guice) for proxy creation</span>
    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="n">RandomNameGenerator</span> <span class="n">generator</span><span class="o">;</span>

    <span class="c1">// sample of hybrid method in repository, using injected service</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">createRandomUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">generator</span><span class="o">.</span><span class="na">generateName</span><span class="o">());</span>
        <span class="n">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@SqlUpdate</span><span class="o">(</span><span class="s">&quot;insert into users (name, version) values (:name, :version)&quot;</span><span class="o">)</span>
    <span class="nd">@GetGeneratedKeys</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">long</span> <span class="nf">insert</span><span class="o">(</span><span class="nd">@UserBind</span> <span class="n">User</span> <span class="n">entry</span><span class="o">);</span>

    <span class="nd">@SqlUpdate</span><span class="o">(</span><span class="s">&quot;update users set version=:version, name=:name where id=:id and version=:version - 1&quot;</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="nd">@UserBind</span> <span class="n">User</span> <span class="n">entry</span><span class="o">);</span>

    <span class="nd">@SqlQuery</span><span class="o">(</span><span class="s">&quot;select * from users&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="nd">@SqlQuery</span><span class="o">(</span><span class="s">&quot;select * from users where name = :name&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">User</span> <span class="nf">findByName</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<p>Where <code>Crud</code> base class tries to unify repositories and provide hibernate-like optimistic locking behaviour 
(on each entity save version field is assigned/incremented and checked during update to prevent data loss):</p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Crud</span><span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">IdEntity</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@InTransaction</span>
    <span class="kd">public</span> <span class="n">T</span> <span class="nf">save</span><span class="o">(</span><span class="kd">final</span> <span class="n">T</span> <span class="n">entry</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// hibernate-like optimistic locking mechanism: provided entity must have the same version as in database</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">entry</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">entry</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">insert</span><span class="o">(</span><span class="n">entry</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">ver</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getVersion</span><span class="o">();</span>
            <span class="n">entry</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">ver</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">update</span><span class="o">(</span><span class="n">entry</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ConcurrentModificationException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                        <span class="s">&quot;Concurrent modification for object %s %s version %s&quot;</span><span class="o">,</span>
                        <span class="n">entry</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">ver</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">entry</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">long</span> <span class="nf">insert</span><span class="o">(</span><span class="n">T</span> <span class="n">entry</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">update</span><span class="o">(</span><span class="n">T</span> <span class="n">entry</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<div class="admonition note">
<p>You don't necessarily need to use <code>Crud</code> - it's an advanced usage example.</p>
</div>
<p>Repository is annotated with <code>@InTransaction</code> to allow using repositories directly: repository method call is the smallest transaction scope. 
Transaction scope could be enlarged by using annotation on calling guice beans or 
<a href="../../extras/jdbi/#manual-transaction-definition">declaring transaction manually</a>.
In order to better understand how transactions work read <a href="../../extras/jdbi/#unit-of-work">unit of work docs section</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>@InTransaction</code> is handled with guice AOP, so you can use any other guice aop related features.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Constructor injection is impossible in repositories, but you can use field injections:
<div class="codehilite"><pre><span></span> <span class="nd">@Inject</span>
 <span class="kd">private</span> <span class="n">RandomNameGenerator</span> <span class="n">generator</span><span class="o">;</span>
</pre></div>
</p>
</div>
<h2 id="result-set-mapper">Result set mapper<a class="headerlink" href="#result-set-mapper" title="Permanent link">&para;</a></h2>
<p>Result set mapper is used to map query result set to entity: </p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserMapper</span> <span class="kd">implements</span> <span class="n">ResultSetMapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">map</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">ResultSet</span> <span class="n">r</span><span class="o">,</span> <span class="n">StatementContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">));</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;version&quot;</span><span class="o">));</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>Mappers are installed with <a href="../../extras/jdbi/#result-set-mapper">mapper installer</a>.
If auto scan is enabled then all mappers will be detected automatically and registered in dbi instance.
Mapper are instantiated as normal guice bean without restrictions: so you can use injection and aop 
(it's only not shown in example mapper).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mapper installer mostly automates (and unifies) registration. If your mapper does not need to be guice bean
and you dont want to use auto configuration then you can register it manually in dbi instance 
(it's available for injection).</p>
</div>
<p>Also, see complementing binding annotation, used to bind object to query parameters:</p>
<div class="codehilite"><pre><span></span><span class="nd">@BindingAnnotation</span><span class="o">(</span><span class="n">UserBind</span><span class="o">.</span><span class="na">UserBinder</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">UserBind</span> <span class="o">{</span>

    <span class="kd">class</span> <span class="nc">UserBinder</span> <span class="kd">implements</span> <span class="n">BinderFactory</span><span class="o">&lt;</span><span class="n">UserBind</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Binder</span> <span class="nf">build</span><span class="o">(</span><span class="n">UserBind</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">Binder</span><span class="o">&lt;</span><span class="n">UserBind</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;)</span> <span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">bind</span><span class="o">,</span> <span class="n">arg</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">q</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;version&quot;</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">getVersion</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">arg</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">};</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>See <code>@UserBind</code> usage above in repository definition.</p>
<p>There is no custom installer for annotation because it's detected automatically by DBI.  </p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>Repositories are used as normal guice beans:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/users&quot;</span><span class="o">)</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;application/json&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserResource</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@POST</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">create</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>UserMapper</code> and <code>UserBind</code> are used implicitly to convert Pojo into db record and back.</p>
<p>You can use <code>@InTransaction</code> on repository method to enlarge transaction scope, but, in contrast
to hibernate you dont't have to always declare it to avoid lazy initialization exception 
(because jdbi produce simple pojos).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>@InTrasaction</code> name was used to avoid confusion with commonly used <code>@Transactional</code> annotation.
You <a href="../../extras/jdbi/#intransaction">can bind any annotation class</a> if you like to use different name (annotation is just a marker)</p>
</div>
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../eventbus/" title="EventBus" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                EventBus
              </span>
            </div>
          </a>
        
        
          <a href="../../extras/admin-rest/" title="Admin REST" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Admin REST
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2014-2017 Vyacheslav Rusakov
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/xvik" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/vyarus" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-2afe21e0b2.js"></script>
      <script>var config={url:{base:"../.."}},app=new Application(config);app.initialize()</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-93174150-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>